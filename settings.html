<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Defini√ß√µes - Mass & Balance</title>

    <link rel="stylesheet" href="design.css">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="auto-update.js" defer></script>
    
    <style>
        /* --- Estilos para as modais --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            box-sizing: border-box;
        }

        .button-danger {
            background-color: var(--danger, #ff4d4d);
        }

        .button-danger:hover {
            background-color: #d32f2f;
        }

        .modal-content .action-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }

        /* Estilos de layout */
        body {
            padding: 1rem;
            box-sizing: border-box;
        }

        h2, h3 {
            text-align: center;
        }

        hr {
            margin: 30px 0;
            border: none;
            border-top: 1px solid #999;
        }

        /* Estilos para tabelas e inputs */
        table {
            width: 100%;
            table-layout: auto;
            border-collapse: collapse;
        }

        table th,
        table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: keep-all;
            padding: 0.5rem;
        }

        table colgroup col:nth-child(1) { width: 25%; }
        table colgroup col:nth-child(2) { width: 15%; }
        table colgroup col:nth-child(3) { width: 15%; }
        table colgroup col:nth-child(4) { width: 15%; }
        table colgroup col:nth-child(5) { width: 15%; }
        table colgroup col:nth-child(6) { width: 15%; }
        
        input,
        select,
        textarea {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>

    <div class="top-buttons">
        <button onclick="location.href='index.html'" title="Voltar para a Calculadora">‚¨ÖÔ∏è</button>
        <button onclick="abrirModalQR()" title="Partilhar App">üì≤</button>
    </div>

    <div id="modalQR" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalQR()">&times;</span>
            <h3>üì≤ Partilhar App</h3>
            <p>Aponta a c√¢mara para o QR code:</p>
            <img src="qr_mb_d228.png" alt="QR Code" style="width: 200px; height: 200px; border: 1px solid #ccc; background: white; padding: 10px;">
        </div>
    </div>

    <div id="modalReset" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModalReset()">&times;</span>
            <h3>‚ö†Ô∏è Confirmar Reset</h3>
            <p>Tem a certeza que quer repor todas as defini√ß√µes? As suas altera√ß√µes (avi√µes, rotas, etc.) ser√£o perdidas.</p>
            <div class="action-buttons">
                <button class="button-danger" onclick="resetarDefinicoes()">Sim, Repor</button>
                <button onclick="fecharModalReset()">Cancelar</button>
            </div>
        </div>
    </div>

    <hr>
    
    <h2>Defini√ß√µes de Pesos Padr√£o</h2>
    <label>Peso padr√£o - Homem (kg):
        <input type="number" inputmode="decimal" step="any" id="pesoHomem" value="86" onfocus="this.select()">
    </label>
    <label>Peso padr√£o - Mulher (kg):
        <input type="number" inputmode="decimal" step="any" id="pesoMulher" value="68" onfocus="this.select()">
    </label>
    <label>Peso padr√£o - Crian√ßa (kg):
        <input type="number" inputmode="decimal" step="any" id="pesoCrianca" value="35" onfocus="this.select()">
    </label>
    <label>Peso padr√£o - Bagagem extra (kg):
        <input type="number" inputmode="decimal" step="any" id="pesoBagagem" value="10" onfocus="this.select()">
    </label>

    <hr>

    <h2>Avi√µes Dispon√≠veis</h2>
    <table>
        <colgroup>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
            <col>
        </colgroup>
        <thead>
            <tr>
                <th>Nome</th>
                <th>BEW</th>
                <th>Momento</th>
                <th>MRW</th>
                <th>MTOW</th>
                <th>MLW</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tabelaAvioes"></tbody>
    </table>

    <h3>Adicionar Novo Avi√£o</h3>
    <input type="text" id="novoNome" placeholder="Nome do avi√£o">
    <input type="number" inputmode="decimal" step="any" id="novoPeso" placeholder="Peso (kg)" onfocus="this.select()">
    <input type="number" inputmode="decimal" step="any" id="novoMomento" placeholder="Momento" onfocus="this.select()">
    <input type="number" inputmode="decimal" step="any" id="novoMRW" placeholder="MRW" onfocus="this.select()">
    <input type="number" inputmode="decimal" step="any" id="novoMTOW" placeholder="MTOW" onfocus="this.select()">
    <input type="number" inputmode="decimal" step="any" id="novoMLW" placeholder="MLW" onfocus="this.select()">
    <button onclick="adicionarAviao()">Adicionar Avi√£o</button>

    <hr>
    
    <h2>Rotas Padr√£o</h2>
    <label>Nome da Rota: <input type="text" id="nomeRota" placeholder="Ex: RVP952/953"></label>
    <button onclick="adicionarLinhaRota()">+ Adicionar Leg</button>
    <table>
        <thead>
            <tr><th>ROUTE</th><th>DEP F. (lb)</th><th>PAYL. (kg)</th><th>TRIP F. (lb)</th><th>Remover</th></tr>
        </thead>
        <tbody id="rotaTemp"></tbody>
    </table>

    <h3>Rotas Guardadas</h3>
    <ul id="listaRotas">
        </ul>

    <hr>
    
    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
        <button class="button-danger" onclick="abrirModalReset()">Reset Defini√ß√µes</button>
        <button onclick="guardarDefinicoes()">Guardar</button>
    </div>
    <br><br>

    <footer style="text-align: right; margin-top: 30px; font-size: 12px; color: #888;">
        <span id="versaoApp"></span>
    </footer>

    <script>
        // Vari√°veis globais para as defini√ß√µes e rotas
        let listaAvioes = [];
        let rotasPadrao = [];

        // --- Fun√ß√µes de Carregamento e Guardar ---
        
        // Carrega as defini√ß√µes padr√£o do ficheiro se n√£o existirem no localStorage.
        async function carregarValoresPadraoSeNecessario() {
            const definicoesExistem = localStorage.getItem("definicoesMB");
            const rotasExistem = localStorage.getItem("rotasPadrao");

            if (definicoesExistem && rotasExistem) {
                return;
            }

            try {
                const response = await fetch('default_settings.json');
                if (!response.ok) throw new Error('A resposta da rede n√£o foi bem-sucedida ao carregar as defini√ß√µes padr√£o.');
                
                const defaults = await response.json();
                
                if (!definicoesExistem) {
                    localStorage.setItem("definicoesMB", JSON.stringify(defaults.definicoesMB));
                }
                if (!rotasExistem) {
                    localStorage.setItem("rotasPadrao", JSON.stringify(defaults.rotasPadrao));
                }
                console.log("Defini√ß√µes padr√£o carregadas com sucesso.");
            } catch (error) {
                console.error("Falha cr√≠tica ao carregar defini√ß√µes padr√£o.", error);
            }
        }

        // Carrega as defini√ß√µes do localStorage para a p√°gina.
        function carregarDefinicoes() {
            const definicoes = JSON.parse(localStorage.getItem("definicoesMB"));
            if (definicoes) {
                document.getElementById("pesoHomem").value = definicoes.pesoHomem || '';
                document.getElementById("pesoMulher").value = definicoes.pesoMulher || '';
                document.getElementById("pesoCrianca").value = definicoes.pesoCrianca || '';
                document.getElementById("pesoBagagem").value = definicoes.pesoBagagem || '';
                listaAvioes = definicoes.avioes || [];
                renderAvioes();
            }

            rotasPadrao = JSON.parse(localStorage.getItem("rotasPadrao")) || [];
            renderizarRotasGuardadas();
        }

        // Guarda todas as defini√ß√µes no localStorage.
        function guardarDefinicoes() {
            const definicoes = {
                pesoHomem: parseFloat(document.getElementById("pesoHomem").value) || 0,
                pesoMulher: parseFloat(document.getElementById("pesoMulher").value) || 0,
                pesoCrianca: parseFloat(document.getElementById("pesoCrianca").value) || 0,
                pesoBagagem: parseFloat(document.getElementById("pesoBagagem").value) || 0,
                avioes: listaAvioes
            };

            // L√≥gica para guardar a nova rota
            const nome = document.getElementById('nomeRota').value.trim();
            const linhas = document.querySelectorAll('#rotaTemp tr');
            const legs = [];
            
            linhas.forEach(row => {
                const inputs = row.querySelectorAll('input');
                legs.push({
                    route: inputs[0].value.trim(),
                    depF: inputs[1].value.trim(),
                    payl: inputs[2].value.trim(),
                    tripF: inputs[3].value.trim()
                });
            });
            
            if (nome && legs.length > 0) {
                const indexExistente = rotasPadrao.findIndex(r => r.nome === nome);
                if (indexExistente !== -1) {
                    if (!confirm(`J√° existe uma rota chamada "${nome}". Queres substituir?`)) {
                        return;
                    }
                    rotasPadrao[indexExistente] = { nome, legs };
                } else {
                    rotasPadrao.push({ nome, legs });
                }
                document.getElementById('rotaTemp').innerHTML = '';
                document.getElementById('nomeRota').value = '';
            }
            
            localStorage.setItem("definicoesMB", JSON.stringify(definicoes));
            localStorage.setItem("rotasPadrao", JSON.stringify(rotasPadrao));
            
            alert("Defini√ß√µes guardadas com sucesso!");
            window.location.href = "index.html";
        }

        // Rep√µe as defini√ß√µes para os valores de f√°brica.
        async function resetarDefinicoes() {
            localStorage.removeItem("definicoesMB");
            localStorage.removeItem("rotasPadrao");
            await carregarValoresPadraoSeNecessario();
            fecharModalReset();
            carregarDefinicoes();
        }

        // --- Fun√ß√µes de Gest√£o de Avi√µes ---
        function renderAvioes() {
            const tabela = document.getElementById("tabelaAvioes");
            tabela.innerHTML = "";
            listaAvioes.forEach((aviao, i) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" value="${aviao.nome}" onchange="atualizarAviao(${i}, 'nome', this.value)" onfocus="this.select()"></td>
                    <td><input type="number" inputmode="decimal" step="any" value="${aviao.peso}" onchange="atualizarAviao(${i}, 'peso', this.value)" onfocus="this.select()"></td>
                    <td><input type="number" inputmode="decimal" step="any" value="${aviao.momento}" onchange="atualizarAviao(${i}, 'momento', this.value)" onfocus="this.select()"></td>
                    <td><input type="number" inputmode="decimal" step="any" value="${aviao.MRW}" onchange="atualizarAviao(${i}, 'MRW', this.value)" onfocus="this.select()"></td>
                    <td><input type="number" inputmode="decimal" step="any" value="${aviao.MTOW}" onchange="atualizarAviao(${i}, 'MTOW', this.value)" onfocus="this.select()"></td>
                    <td><input type="number" inputmode="decimal" step="any" value="${aviao.MLW}" onchange="atualizarAviao(${i}, 'MLW', this.value)" onfocus="this.select()"></td>
                    <td class="actions"><button onclick="removerAviao(${i})">Remover</button></td>
                `;
                tabela.appendChild(row);
            });
        }

        function atualizarAviao(index, campo, valor) {
            listaAvioes[index][campo] = campo === 'nome' ? valor : parseFloat(valor);
        }

        function removerAviao(index) {
            listaAvioes.splice(index, 1);
            renderAvioes();
        }

        function adicionarAviao() {
            const nome = document.getElementById("novoNome").value;
            const peso = parseFloat(document.getElementById("novoPeso").value);
            const momento = parseFloat(document.getElementById("novoMomento").value);
            const MRW = parseFloat(document.getElementById("novoMRW").value);
            const MTOW = parseFloat(document.getElementById("novoMTOW").value);
            const MLW = parseFloat(document.getElementById("novoMLW").value);

            if (!nome || isNaN(peso) || isNaN(momento) || isNaN(MRW) || isNaN(MTOW) || isNaN(MLW)) {
                alert("Preencha todos os campos do novo avi√£o.");
                return;
            }
            listaAvioes.push({ nome, peso, momento, MRW, MTOW, MLW });
            document.getElementById("novoNome").value = "";
            document.getElementById("novoPeso").value = "";
            document.getElementById("novoMomento").value = "";
            document.getElementById("novoMRW").value = "";
            document.getElementById("novoMTOW").value = "";
            document.getElementById("novoMLW").value = "";
            renderAvioes();
        }
        
        // --- Fun√ß√µes de Gest√£o de Rotas ---
        function adicionarLinhaRota(route = '', depF = '', payl = '', tripF = '') {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" value="${route}"></td>
                <td><input type="number" value="${depF}"></td>
                <td><input type="number" value="${payl}"></td>
                <td><input type="number" value="${tripF}"></td>
                <td><button onclick="this.closest('tr').remove()">X</button></td>
            `;
            document.getElementById('rotaTemp').appendChild(tr);
        }
        
        function renderizarRotasGuardadas() {
            const lista = document.getElementById('listaRotas');
            lista.innerHTML = '';
            rotasPadrao.forEach((rota, idx) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    ${rota.nome}
                    <button onclick="editarRota(${idx})">Editar</button>
                    <button onclick="removerRota(${idx})">Remover</button>
                `;
                lista.appendChild(li);
            });
        }
        
        function removerRota(index) {
            if (confirm('Apagar esta rota definitivamente?')) {
                rotasPadrao.splice(index, 1);
                localStorage.setItem('rotasPadrao', JSON.stringify(rotasPadrao));
                renderizarRotasGuardadas();
            }
        }
        
        function editarRota(index) {
            const rota = rotasPadrao[index];
            document.getElementById('nomeRota').value = rota.nome;
            document.getElementById('rotaTemp').innerHTML = '';
            rota.legs.forEach(leg => {
                adicionarLinhaRota(leg.route, leg.depF, leg.payl, leg.tripF);
            });
            rotasPadrao.splice(index, 1);
            renderizarRotasGuardadas();
        }

        // --- Fun√ß√µes para Modais ---
        function abrirModalQR() {
            document.getElementById("modalQR").style.display = "flex";
        }

        function fecharModalQR() {
            document.getElementById("modalQR").style.display = "none";
        }

        function abrirModalReset() {
            document.getElementById("modalReset").style.display = "flex";
        }

        function fecharModalReset() {
            document.getElementById("modalReset").style.display = "none";
        }

        // Event listener para fechar modais ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        }

        // --- Inicializa√ß√£o ---
        window.onload = async () => {
            await carregarValoresPadraoSeNecessario();
            carregarDefinicoes();
        };

        // Scripts da vers√£o da app e icons
        <script src="app-version.js"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                if (typeof APP_VERSION !== 'undefined') {
                    document.getElementById('versaoApp').innerText = 'Vers√£o: ' + APP_VERSION;
                }
                feather.replace();
            });
        </script>
    </script>
</body>
</html>
